import type React from "react";

import ReactFlow, {
  addEdge, Background,
  type Connection,
  type Edge,
  type Node,
  type NodeTypes,
  type ReactFlowInstance,
  useEdgesState,
  useNodesState,
  useReactFlow,
} from "reactflow";
import "reactflow/dist/style.css";
import { useCallback, useEffect, useMemo, useRef, useState } from "react";
import useSessionStoreSync from "@/hooks/useSessionStoreSync.ts";
import MacOSNode from "@/routes/main/canvas/MacOSNode.tsx";
import { ChevronDown, ChevronRight, Filter, ShoppingBag } from "lucide-react";
import { cleanBrands, cn } from "@/lib/utils";
import Graphite from "@/components/ui/vectors/logos/Graphite.tsx";

const NODES_STORAGE_KEY = "stels-canvas-nodes";
const EDGES_STORAGE_KEY = "stels-canvas-edges";

interface FlowNodeData {
  channel: string;
  label: string;
  onDelete: (nodeId: string) => void;
  sessionData?: unknown;
}

type FlowNode = Node<FlowNodeData>;

const defaultNodes: any[] = [
  {
    "id": "node-1754614994904",
    "type": "custom",
    "position": {
      "x": -1575,
      "y": 3570
    },
    "data": {
      "channel": "testnet.runtime.connector.exchange.crypto.bybit.futures.SOL/USDT:USDT.ticker",
      "label": "testnet.runtime.connector.exchange.crypto.bybit.futures.SOL/USDT:USDT.ticker",
      "sessionData": {
        "channel": "testnet.runtime.connector.exchange.crypto.bybit.futures.SOL/USDT:USDT.ticker",
        "module": "ticker",
        "widget": "widget.testnet.runtime.connector.exchange.crypto.bybit.futures.SOL/USDT:USDT.ticker",
        "raw": {
          "exchange": "bybit",
          "market": "SOL/USDT:USDT",
          "last": 174.34,
          "bid": 174.34,
          "ask": 174.35,
          "change": 6.63,
          "percentage": 3.9532,
          "baseVolume": 11193069.1,
          "quoteVolume": 1917814489.803,
          "timestamp": 1754614992074,
          "latency": 1446
        },
        "timestamp": 1754614992074
      }
    },
    "dragHandle": ".drag-handle",
    "width": 522,
    "height": 264,
    "selected": false,
    "positionAbsolute": {
      "x": -1575,
      "y": 3570
    },
    "dragging": false
  },
  {
    "id": "node-1754615010925",
    "type": "custom",
    "position": {
      "x": -1575,
      "y": 4245
    },
    "data": {
      "channel": "testnet.runtime.connector.exchange.crypto.bybit.futures.BTC/USDT:USDT.ticker",
      "label": "testnet.runtime.connector.exchange.crypto.bybit.futures.BTC/USDT:USDT.ticker",
      "sessionData": {
        "channel": "testnet.runtime.connector.exchange.crypto.bybit.futures.BTC/USDT:USDT.ticker",
        "module": "ticker",
        "widget": "widget.testnet.runtime.connector.exchange.crypto.bybit.futures.BTC/USDT:USDT.ticker",
        "raw": {
          "exchange": "bybit",
          "market": "BTC/USDT:USDT",
          "last": 117105.2,
          "bid": 117105,
          "ask": 117105.1,
          "change": 2241.5,
          "percentage": 1.9514,
          "baseVolume": 71991.378,
          "quoteVolume": 8363138804.1978,
          "timestamp": 1754615004834,
          "latency": 3830
        },
        "timestamp": 1754615004834
      }
    },
    "dragHandle": ".drag-handle",
    "width": 522,
    "height": 264,
    "selected": false,
    "positionAbsolute": {
      "x": -1575,
      "y": 4245
    },
    "dragging": false
  },
  {
    "id": "node-1754615066574",
    "type": "custom",
    "position": {
      "x": -1575,
      "y": 3840
    },
    "data": {
      "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.ticker",
      "label": "testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.ticker",
      "sessionData": {
        "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.ticker",
        "module": "ticker",
        "widget": "widget.testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.ticker",
        "raw": {
          "exchange": "bybit",
          "market": "SOL/USDT",
          "last": 173.97,
          "bid": 173.96,
          "ask": 173.97,
          "change": 6.13,
          "percentage": 3.65,
          "baseVolume": 1037434.059,
          "quoteVolume": 177730766.19693,
          "timestamp": 1754615062253,
          "latency": 1473
        },
        "timestamp": 1754615062253
      }
    },
    "dragHandle": ".drag-handle",
    "width": 522,
    "height": 264,
    "selected": false,
    "positionAbsolute": {
      "x": -1575,
      "y": 3840
    },
    "dragging": false
  },
  {
    "id": "node-1754615073211",
    "type": "custom",
    "position": {
      "x": -1575,
      "y": 4530
    },
    "data": {
      "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.ticker",
      "label": "testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.ticker",
      "sessionData": {
        "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.ticker",
        "module": "ticker",
        "widget": "widget.testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.ticker",
        "raw": {
          "exchange": "bybit",
          "market": "BTC/USDT",
          "last": 117008.7,
          "bid": 117008.6,
          "ask": 117008.7,
          "change": 2119.5,
          "percentage": 1.84,
          "baseVolume": 7169.934816,
          "quoteVolume": 833697716.2937976,
          "timestamp": 1754615068300,
          "latency": 3618
        },
        "timestamp": 1754615068300
      }
    },
    "dragHandle": ".drag-handle",
    "width": 522,
    "height": 264,
    "selected": false,
    "positionAbsolute": {
      "x": -1575,
      "y": 4530
    },
    "dragging": false
  },
  {
    "id": "node-1754720365581",
    "type": "custom",
    "position": {
      "x": -2295,
      "y": 3570
    },
    "data": {
      "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.candles",
      "label": "testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.candles",
      "sessionData": {
        "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.candles",
        "module": "ohlcv",
        "widget": "widget.testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.candles",
        "raw": {
          "exchange": "bybit",
          "market": "SOL/USDT",
          "timeframe": "1m",
          "candles": [
            [
              1754714400000,
              178.35,
              178.46,
              178.17,
              178.46,
              305.039
            ],
            [
              1754714460000,
              178.46,
              178.55,
              178.39,
              178.51,
              428.709
            ],
            [
              1754714520000,
              178.51,
              178.51,
              178.03,
              178.15,
              531.908
            ],
            [
              1754714580000,
              178.15,
              178.17,
              178.01,
              178.07,
              327.424
            ],
            [
              1754714640000,
              178.07,
              178.09,
              177.96,
              177.97,
              246.854
            ],
            [
              1754714700000,
              177.97,
              178,
              177.88,
              177.95,
              1616.288
            ],
            [
              1754714760000,
              177.95,
              178.23,
              177.9,
              178.19,
              184.813
            ],
            [
              1754714820000,
              178.19,
              178.19,
              178.08,
              178.08,
              240.001
            ],
            [
              1754714880000,
              178.08,
              178.12,
              177.96,
              178.05,
              381.061
            ],
            [
              1754714940000,
              178.05,
              178.14,
              177.94,
              177.98,
              551.963
            ],
            [
              1754715000000,
              177.98,
              178.12,
              177.96,
              178.08,
              477.038
            ],
            [
              1754715060000,
              178.08,
              178.13,
              178,
              178.06,
              162.461
            ],
            [
              1754715120000,
              178.06,
              178.15,
              178.02,
              178.06,
              193.332
            ],
            [
              1754715180000,
              178.06,
              178.13,
              177.98,
              178.13,
              385.733
            ],
            [
              1754715240000,
              178.13,
              178.16,
              178.07,
              178.07,
              157.204
            ],
            [
              1754715300000,
              178.07,
              178.2,
              178.07,
              178.12,
              361.416
            ],
            [
              1754715360000,
              178.12,
              178.32,
              178.12,
              178.32,
              159.295
            ],
            [
              1754715420000,
              178.32,
              178.61,
              178.27,
              178.61,
              2828.437
            ],
            [
              1754715480000,
              178.61,
              178.86,
              178.57,
              178.71,
              2975.86
            ],
            [
              1754715540000,
              178.71,
              178.71,
              178.59,
              178.67,
              128.213
            ],
            [
              1754715600000,
              178.67,
              178.69,
              178.27,
              178.37,
              1510.533
            ],
            [
              1754715660000,
              178.37,
              178.94,
              178.37,
              178.93,
              828.259
            ],
            [
              1754715720000,
              178.93,
              179.47,
              178.92,
              179.28,
              6622.303
            ],
            [
              1754715780000,
              179.28,
              179.41,
              179.25,
              179.41,
              1328.206
            ],
            [
              1754715840000,
              179.41,
              179.67,
              179.22,
              179.66,
              2052.766
            ],
            [
              1754715900000,
              179.66,
              180,
              179.33,
              179.95,
              4965.894
            ],
            [
              1754715960000,
              179.95,
              180.3,
              179.74,
              179.92,
              11251.734
            ],
            [
              1754716020000,
              179.92,
              180.05,
              179.67,
              179.99,
              1982.506
            ],
            [
              1754716080000,
              179.99,
              180.61,
              179.91,
              180.42,
              6085.177
            ],
            [
              1754716140000,
              180.42,
              180.69,
              180.21,
              180.22,
              3230.137
            ],
            [
              1754716200000,
              180.22,
              180.22,
              179.74,
              179.94,
              3691.616
            ],
            [
              1754716260000,
              179.94,
              180.08,
              179.85,
              179.99,
              978.677
            ],
            [
              1754716320000,
              179.99,
              180.02,
              179.8,
              179.84,
              778.21
            ],
            [
              1754716380000,
              179.84,
              179.96,
              179.63,
              179.93,
              716.572
            ],
            [
              1754716440000,
              179.93,
              180.34,
              179.9,
              180.18,
              2539.181
            ],
            [
              1754716500000,
              180.18,
              180.36,
              180.09,
              180.35,
              852.323
            ],
            [
              1754716560000,
              180.35,
              180.76,
              180.28,
              180.76,
              2990.565
            ],
            [
              1754716620000,
              180.76,
              180.97,
              180.71,
              180.87,
              1673.533
            ],
            [
              1754716680000,
              180.87,
              181.11,
              180.77,
              180.85,
              3082.101
            ],
            [
              1754716740000,
              180.85,
              181.12,
              180.84,
              181.07,
              877.694
            ],
            [
              1754716800000,
              181.07,
              181.27,
              180.94,
              181.25,
              2058.281
            ],
            [
              1754716860000,
              181.25,
              181.29,
              181.15,
              181.25,
              1158.821
            ],
            [
              1754716920000,
              181.25,
              181.29,
              180.94,
              181.29,
              985.255
            ],
            [
              1754716980000,
              181.29,
              181.58,
              181.29,
              181.48,
              1728.97
            ],
            [
              1754717040000,
              181.48,
              181.59,
              181.36,
              181.58,
              1066.457
            ],
            [
              1754717100000,
              181.58,
              181.63,
              181.35,
              181.56,
              718.716
            ],
            [
              1754717160000,
              181.56,
              181.7,
              181.44,
              181.7,
              1493.925
            ],
            [
              1754717220000,
              181.7,
              181.92,
              181.69,
              181.9,
              848.66
            ],
            [
              1754717280000,
              181.9,
              181.9,
              181.59,
              181.69,
              4172.734
            ],
            [
              1754717340000,
              181.69,
              181.78,
              181.64,
              181.68,
              715.828
            ],
            [
              1754717400000,
              181.68,
              181.75,
              181.47,
              181.63,
              1583.465
            ],
            [
              1754717460000,
              181.63,
              181.92,
              181.56,
              181.89,
              3103.976
            ],
            [
              1754717520000,
              181.89,
              181.91,
              181.65,
              181.81,
              1290.622
            ],
            [
              1754717580000,
              181.81,
              182,
              181.81,
              181.96,
              4799.659
            ],
            [
              1754717640000,
              181.96,
              182.14,
              181.96,
              182.02,
              2121.712
            ],
            [
              1754717700000,
              182.02,
              182.14,
              182.01,
              182.1,
              517.839
            ],
            [
              1754717760000,
              182.1,
              182.15,
              182.05,
              182.11,
              1094.5
            ],
            [
              1754717820000,
              182.11,
              182.11,
              181.44,
              181.46,
              1775.258
            ],
            [
              1754717880000,
              181.46,
              181.58,
              181.27,
              181.53,
              2688.995
            ],
            [
              1754717940000,
              181.53,
              181.79,
              181.51,
              181.75,
              1717.671
            ],
            [
              1754718000000,
              181.75,
              181.75,
              181.56,
              181.67,
              1148.391
            ],
            [
              1754718060000,
              181.67,
              181.67,
              181.36,
              181.56,
              1128.596
            ],
            [
              1754718120000,
              181.56,
              181.57,
              181.35,
              181.39,
              1482.066
            ],
            [
              1754718180000,
              181.39,
              181.59,
              181.35,
              181.46,
              3739.121
            ],
            [
              1754718240000,
              181.46,
              181.46,
              181.01,
              181.2,
              4404.852
            ],
            [
              1754718300000,
              181.2,
              181.38,
              181.16,
              181.38,
              761.697
            ],
            [
              1754718360000,
              181.38,
              181.68,
              181.38,
              181.68,
              1343.324
            ],
            [
              1754718420000,
              181.68,
              181.84,
              181.65,
              181.69,
              476.13
            ],
            [
              1754718480000,
              181.69,
              181.69,
              181.43,
              181.58,
              541.432
            ],
            [
              1754718540000,
              181.58,
              181.71,
              181.52,
              181.7,
              382.73
            ],
            [
              1754718600000,
              181.7,
              181.77,
              181.47,
              181.49,
              934.139
            ],
            [
              1754718660000,
              181.49,
              181.71,
              181.43,
              181.48,
              521.539
            ],
            [
              1754718720000,
              181.48,
              181.69,
              181.48,
              181.58,
              346.889
            ],
            [
              1754718780000,
              181.58,
              181.66,
              181.52,
              181.61,
              477.861
            ],
            [
              1754718840000,
              181.61,
              181.61,
              181.38,
              181.42,
              441.654
            ],
            [
              1754718900000,
              181.42,
              181.43,
              180.99,
              181.12,
              1259.406
            ],
            [
              1754718960000,
              181.12,
              181.15,
              180.86,
              180.89,
              584.569
            ],
            [
              1754719020000,
              180.89,
              181.04,
              180.84,
              180.96,
              575.743
            ],
            [
              1754719080000,
              180.96,
              181.01,
              180.87,
              180.93,
              390.803
            ],
            [
              1754719140000,
              180.93,
              180.94,
              180.82,
              180.87,
              283.649
            ],
            [
              1754719200000,
              180.87,
              180.94,
              180.81,
              180.83,
              330.768
            ],
            [
              1754719260000,
              180.83,
              180.86,
              180.7,
              180.75,
              1451.586
            ],
            [
              1754719320000,
              180.75,
              180.79,
              180.61,
              180.62,
              780.969
            ],
            [
              1754719380000,
              180.62,
              180.72,
              180.52,
              180.62,
              1018.764
            ],
            [
              1754719440000,
              180.62,
              180.72,
              180.51,
              180.51,
              277.652
            ],
            [
              1754719500000,
              180.51,
              180.51,
              180.07,
              180.35,
              1705.747
            ],
            [
              1754719560000,
              180.35,
              180.52,
              180.32,
              180.52,
              655.345
            ],
            [
              1754719620000,
              180.52,
              180.82,
              180.52,
              180.76,
              1314.271
            ],
            [
              1754719680000,
              180.76,
              180.83,
              180.69,
              180.72,
              757.343
            ],
            [
              1754719740000,
              180.72,
              180.72,
              180.32,
              180.51,
              759.792
            ],
            [
              1754719800000,
              180.51,
              180.57,
              180.45,
              180.47,
              437.639
            ],
            [
              1754719860000,
              180.47,
              180.57,
              180.22,
              180.56,
              5869.284
            ],
            [
              1754719920000,
              180.56,
              180.56,
              180.4,
              180.43,
              213.469
            ],
            [
              1754719980000,
              180.43,
              180.55,
              180.39,
              180.39,
              283.28
            ],
            [
              1754720040000,
              180.39,
              180.39,
              180.11,
              180.11,
              302.843
            ],
            [
              1754720100000,
              180.11,
              180.21,
              179.96,
              179.99,
              779.246
            ],
            [
              1754720160000,
              179.99,
              179.99,
              179.65,
              179.79,
              8667.741
            ],
            [
              1754720220000,
              179.79,
              179.8,
              179.64,
              179.72,
              1501.057
            ],
            [
              1754720280000,
              179.72,
              180.03,
              179.66,
              179.99,
              1445.889
            ],
            [
              1754720340000,
              179.99,
              180.1,
              179.97,
              180.06,
              1296.781
            ]
          ],
          "timestamp": 1754720360778,
          "latency": 2600
        },
        "timestamp": 1754720360778
      }
    },
    "dragHandle": ".drag-handle",
    "width": 702,
    "height": 484,
    "selected": false,
    "positionAbsolute": {
      "x": -2295,
      "y": 3570
    },
    "dragging": false
  },
  {
    "id": "node-1754720401467",
    "type": "custom",
    "position": {
      "x": -2295,
      "y": 4245
    },
    "data": {
      "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.candles",
      "label": "testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.candles",
      "sessionData": {
        "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.candles",
        "module": "ohlcv",
        "widget": "widget.testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.candles",
        "raw": {
          "exchange": "bybit",
          "market": "BTC/USDT",
          "timeframe": "1m",
          "candles": [
            [
              1754714400000,
              116629.8,
              116629.9,
              116572.2,
              116602.6,
              3.473654
            ],
            [
              1754714460000,
              116602.6,
              116602.7,
              116583,
              116583.1,
              1.322412
            ],
            [
              1754714520000,
              116583.1,
              116583.1,
              116492.2,
              116498.8,
              2.761169
            ],
            [
              1754714580000,
              116498.8,
              116498.8,
              116440.1,
              116440.2,
              1.605462
            ],
            [
              1754714640000,
              116440.2,
              116440.2,
              116400,
              116412.8,
              5.023485
            ],
            [
              1754714700000,
              116412.8,
              116418.1,
              116394.7,
              116394.8,
              2.183193
            ],
            [
              1754714760000,
              116394.8,
              116407.5,
              116394.7,
              116406.4,
              1.441025
            ],
            [
              1754714820000,
              116406.4,
              116407.4,
              116401.5,
              116401.6,
              0.800269
            ],
            [
              1754714880000,
              116401.6,
              116401.6,
              116370.8,
              116375.3,
              1.50812
            ],
            [
              1754714940000,
              116375.3,
              116394.2,
              116375.3,
              116382,
              2.705796
            ],
            [
              1754715000000,
              116382,
              116394,
              116381.8,
              116394,
              1.568747
            ],
            [
              1754715060000,
              116394,
              116394.2,
              116387.9,
              116389.1,
              2.819801
            ],
            [
              1754715120000,
              116389.1,
              116445.3,
              116389,
              116424.9,
              4.641635
            ],
            [
              1754715180000,
              116424.9,
              116425,
              116407,
              116407,
              0.520032
            ],
            [
              1754715240000,
              116407,
              116407.1,
              116394,
              116394,
              0.597682
            ],
            [
              1754715300000,
              116394,
              116394,
              116392.7,
              116392.8,
              0.167587
            ],
            [
              1754715360000,
              116392.8,
              116407.1,
              116392.7,
              116407.1,
              1.61345
            ],
            [
              1754715420000,
              116407.1,
              116440.1,
              116407,
              116440.1,
              1.554367
            ],
            [
              1754715480000,
              116440.1,
              116440.1,
              116434.3,
              116434.3,
              0.545315
            ],
            [
              1754715540000,
              116434.3,
              116434.4,
              116431,
              116433.4,
              0.676568
            ],
            [
              1754715600000,
              116433.4,
              116433.4,
              116405.1,
              116405.1,
              1.439589
            ],
            [
              1754715660000,
              116405.1,
              116449.8,
              116405.1,
              116449.8,
              2.198858
            ],
            [
              1754715720000,
              116449.8,
              116493.2,
              116449.7,
              116484.7,
              3.417457
            ],
            [
              1754715780000,
              116484.7,
              116492.2,
              116484.7,
              116492.1,
              0.18209
            ],
            [
              1754715840000,
              116492.1,
              116561.5,
              116492.1,
              116553.3,
              5.428773
            ],
            [
              1754715900000,
              116553.3,
              116632.5,
              116502.4,
              116596,
              15.553938
            ],
            [
              1754715960000,
              116596,
              116749,
              116574.4,
              116637.1,
              26.308448
            ],
            [
              1754716020000,
              116637.1,
              116678.2,
              116597,
              116666.4,
              8.000885
            ],
            [
              1754716080000,
              116666.4,
              116752.6,
              116648.8,
              116716.7,
              8.567726
            ],
            [
              1754716140000,
              116716.7,
              116747.6,
              116645.9,
              116645.9,
              5.830739
            ],
            [
              1754716200000,
              116645.9,
              116645.9,
              116520.6,
              116559.2,
              7.574548
            ],
            [
              1754716260000,
              116559.2,
              116569.3,
              116508,
              116532.7,
              5.449663
            ],
            [
              1754716320000,
              116532.7,
              116540.9,
              116481.8,
              116506.6,
              5.037077
            ],
            [
              1754716380000,
              116506.6,
              116547.6,
              116503.3,
              116525.6,
              3.638318
            ],
            [
              1754716440000,
              116525.6,
              116561.2,
              116514.3,
              116542.3,
              5.174573
            ],
            [
              1754716500000,
              116542.3,
              116579.8,
              116542.2,
              116578.7,
              4.705002
            ],
            [
              1754716560000,
              116578.7,
              116599.8,
              116556.4,
              116599.8,
              6.216707
            ],
            [
              1754716620000,
              116599.8,
              116649.8,
              116591.5,
              116649.7,
              2.398963
            ],
            [
              1754716680000,
              116649.7,
              116709.3,
              116649.7,
              116701.8,
              5.336418
            ],
            [
              1754716740000,
              116701.8,
              116794.7,
              116701.8,
              116788.5,
              9.05899
            ],
            [
              1754716800000,
              116788.5,
              116852.4,
              116737.1,
              116852.4,
              6.234321
            ],
            [
              1754716860000,
              116852.4,
              116930.5,
              116852.4,
              116930.5,
              4.748423
            ],
            [
              1754716920000,
              116930.5,
              116949.4,
              116880.4,
              116949.3,
              20.502171
            ],
            [
              1754716980000,
              116949.3,
              116985.6,
              116930.7,
              116962.2,
              3.940752
            ],
            [
              1754717040000,
              116962.2,
              116983.4,
              116948.3,
              116971.8,
              4.046461
            ],
            [
              1754717100000,
              116971.8,
              116971.8,
              116869.3,
              116927.2,
              4.557808
            ],
            [
              1754717160000,
              116927.2,
              116970.3,
              116921.2,
              116970.3,
              3.160459
            ],
            [
              1754717220000,
              116970.3,
              116987.9,
              116961.5,
              116985,
              4.672624
            ],
            [
              1754717280000,
              116985,
              116988,
              116949.9,
              116950,
              2.110967
            ],
            [
              1754717340000,
              116950,
              116973.4,
              116949.9,
              116972.2,
              7.135766
            ],
            [
              1754717400000,
              116972.2,
              116972.3,
              116949.9,
              116955.6,
              1.668048
            ],
            [
              1754717460000,
              116955.6,
              116955.7,
              116921.2,
              116921.3,
              1.936004
            ],
            [
              1754717520000,
              116921.3,
              116953.4,
              116886.2,
              116953.3,
              3.057999
            ],
            [
              1754717580000,
              116953.3,
              116970.5,
              116947,
              116947,
              12.556288
            ],
            [
              1754717640000,
              116947,
              116952.8,
              116947,
              116952.8,
              1.44502
            ],
            [
              1754717700000,
              116952.8,
              116952.9,
              116952.8,
              116952.9,
              0.608975
            ],
            [
              1754717760000,
              116952.9,
              116952.9,
              116923.5,
              116923.5,
              12.58476
            ],
            [
              1754717820000,
              116923.5,
              116923.5,
              116801,
              116801,
              4.516578
            ],
            [
              1754717880000,
              116801,
              116801.1,
              116718.5,
              116795.3,
              13.002208
            ],
            [
              1754717940000,
              116795.3,
              116878.3,
              116763.8,
              116868.2,
              15.518683
            ],
            [
              1754718000000,
              116868.2,
              116872.3,
              116821.9,
              116860.7,
              4.802027
            ],
            [
              1754718060000,
              116860.7,
              116877.4,
              116845.3,
              116845.3,
              21.999097
            ],
            [
              1754718120000,
              116845.3,
              116861.2,
              116845.3,
              116858.9,
              1.00572
            ],
            [
              1754718180000,
              116858.9,
              116896.9,
              116855.3,
              116891.5,
              11.121355
            ],
            [
              1754718240000,
              116891.5,
              116906.7,
              116862.7,
              116906.6,
              1.430422
            ],
            [
              1754718300000,
              116906.6,
              116906.7,
              116879.3,
              116896,
              2.703367
            ],
            [
              1754718360000,
              116896,
              116930,
              116896,
              116915,
              1.552843
            ],
            [
              1754718420000,
              116915,
              116936.2,
              116912.7,
              116912.7,
              2.299175
            ],
            [
              1754718480000,
              116912.7,
              116912.8,
              116846.8,
              116865,
              6.977694
            ],
            [
              1754718540000,
              116865,
              116896.3,
              116864.9,
              116895.2,
              2.715891
            ],
            [
              1754718600000,
              116895.2,
              116895.2,
              116827,
              116827.1,
              3.747412
            ],
            [
              1754718660000,
              116827.1,
              116864.2,
              116815.3,
              116815.4,
              4.000415
            ],
            [
              1754718720000,
              116815.4,
              116849.5,
              116815.3,
              116828.6,
              2.323571
            ],
            [
              1754718780000,
              116828.6,
              116849.4,
              116810.4,
              116810.4,
              9.395879
            ],
            [
              1754718840000,
              116810.4,
              116810.4,
              116744.6,
              116787.2,
              11.274968
            ],
            [
              1754718900000,
              116787.2,
              116787.7,
              116708.1,
              116733.6,
              4.778374
            ],
            [
              1754718960000,
              116733.6,
              116747.4,
              116727.1,
              116727.1,
              2.297127
            ],
            [
              1754719020000,
              116727.1,
              116736.3,
              116727.1,
              116736.3,
              0.610484
            ],
            [
              1754719080000,
              116736.3,
              116743.3,
              116732.9,
              116739.7,
              1.565264
            ],
            [
              1754719140000,
              116739.7,
              116739.8,
              116739.7,
              116739.8,
              0.332251
            ],
            [
              1754719200000,
              116739.8,
              116752.5,
              116738.2,
              116738.2,
              2.73099
            ],
            [
              1754719260000,
              116738.2,
              116738.3,
              116704.6,
              116705.3,
              3.969578
            ],
            [
              1754719320000,
              116705.3,
              116708.9,
              116693.5,
              116698.4,
              5.256068
            ],
            [
              1754719380000,
              116698.4,
              116713.2,
              116689.8,
              116692.4,
              2.822585
            ],
            [
              1754719440000,
              116692.4,
              116701.5,
              116670.8,
              116670.9,
              2.588013
            ],
            [
              1754719500000,
              116670.9,
              116670.9,
              116583.3,
              116624.2,
              5.301241
            ],
            [
              1754719560000,
              116624.2,
              116645.8,
              116624.1,
              116639.1,
              2.044482
            ],
            [
              1754719620000,
              116639.1,
              116652.7,
              116639.1,
              116648.9,
              1.935685
            ],
            [
              1754719680000,
              116648.9,
              116652.6,
              116639.1,
              116643.1,
              1.634883
            ],
            [
              1754719740000,
              116643.1,
              116643.1,
              116576.5,
              116604.4,
              5.121291
            ],
            [
              1754719800000,
              116604.4,
              116613.8,
              116600.1,
              116602.7,
              0.969226
            ],
            [
              1754719860000,
              116602.7,
              116604.7,
              116590.4,
              116604.7,
              0.698935
            ],
            [
              1754719920000,
              116604.7,
              116604.7,
              116572.5,
              116583.8,
              1.239799
            ],
            [
              1754719980000,
              116583.8,
              116592.2,
              116583.8,
              116588.5,
              1.598033
            ],
            [
              1754720040000,
              116588.5,
              116588.5,
              116576,
              116576,
              1.162689
            ],
            [
              1754720100000,
              116576,
              116576.1,
              116568.8,
              116568.8,
              0.304145
            ],
            [
              1754720160000,
              116568.8,
              116568.9,
              116540.2,
              116563.5,
              2.30104
            ],
            [
              1754720220000,
              116563.5,
              116598.1,
              116563.5,
              116598.1,
              1.498018
            ],
            [
              1754720280000,
              116598.1,
              116641.5,
              116598,
              116641.5,
              1.298369
            ],
            [
              1754720340000,
              116641.5,
              116650,
              116639,
              116639.1,
              2.060817
            ]
          ],
          "timestamp": 1754720391019,
          "latency": 2890
        },
        "timestamp": 1754720391019
      }
    },
    "dragHandle": ".drag-handle",
    "width": 702,
    "height": 484,
    "selected": false,
    "positionAbsolute": {
      "x": -2295,
      "y": 4245
    },
    "dragging": false
  },
  {
    "id": "node-1754720488918",
    "type": "custom",
    "position": {
      "x": -1035,
      "y": 4245
    },
    "data": {
      "channel": "testnet.runtime.connector.exchange.crypto.bybit.futures.BTC/USDT:USDT.book",
      "label": "testnet.runtime.connector.exchange.crypto.bybit.futures.BTC/USDT:USDT.book",
      "sessionData": {
        "channel": "testnet.runtime.connector.exchange.crypto.bybit.futures.BTC/USDT:USDT.book",
        "module": "book",
        "widget": "widget.testnet.runtime.connector.exchange.crypto.bybit.futures.BTC/USDT:USDT.book",
        "raw": {
          "exchange": "bybit",
          "market": "BTC/USDT:USDT",
          "bids": [
            [
              116669.5,
              4.155
            ],
            [
              116669.4,
              0.1
            ],
            [
              116669,
              0.257
            ],
            [
              116667.5,
              0.001
            ],
            [
              116667.4,
              0.002
            ],
            [
              116666.3,
              0.002
            ],
            [
              116666,
              0.031
            ],
            [
              116665.4,
              0.001
            ],
            [
              116665.1,
              0.002
            ],
            [
              116664.2,
              0.001
            ]
          ],
          "asks": [
            [
              116669.6,
              5.838
            ],
            [
              116670,
              0.033
            ],
            [
              116672,
              1.031
            ],
            [
              116672.1,
              0.001
            ],
            [
              116672.4,
              0.001
            ],
            [
              116673.2,
              0.002
            ],
            [
              116673.7,
              1.639
            ],
            [
              116673.9,
              2.285
            ],
            [
              116674,
              0.032
            ],
            [
              116674.1,
              0.009
            ]
          ],
          "volume": [
            4.552,
            10.871
          ],
          "timestamp": 1754720476309,
          "latency": 4036
        },
        "timestamp": 1754720476309
      }
    },
    "dragHandle": ".drag-handle",
    "width": 452,
    "height": 658,
    "selected": false,
    "positionAbsolute": {
      "x": -1035,
      "y": 4245
    },
    "dragging": false
  },
  {
    "id": "node-1754720503196",
    "type": "custom",
    "position": {
      "x": -1035,
      "y": 3570
    },
    "data": {
      "channel": "testnet.runtime.connector.exchange.crypto.bybit.futures.SOL/USDT:USDT.book",
      "label": "testnet.runtime.connector.exchange.crypto.bybit.futures.SOL/USDT:USDT.book",
      "sessionData": {
        "channel": "testnet.runtime.connector.exchange.crypto.bybit.futures.SOL/USDT:USDT.book",
        "module": "book",
        "widget": "widget.testnet.runtime.connector.exchange.crypto.bybit.futures.SOL/USDT:USDT.book",
        "raw": {
          "exchange": "bybit",
          "market": "SOL/USDT:USDT",
          "bids": [
            [
              180.09,
              196
            ],
            [
              180.08,
              556.5
            ],
            [
              180.07,
              1026.3
            ],
            [
              180.06,
              1358.8
            ],
            [
              180.05,
              1107.7
            ],
            [
              180.04,
              1548.3
            ],
            [
              180.03,
              1433.9
            ],
            [
              180.02,
              1407.1
            ],
            [
              180.01,
              2054.4
            ],
            [
              180,
              1349.2
            ]
          ],
          "asks": [
            [
              180.1,
              209.6
            ],
            [
              180.11,
              73
            ],
            [
              180.12,
              644.2
            ],
            [
              180.13,
              1138
            ],
            [
              180.14,
              1193.4
            ],
            [
              180.15,
              1790
            ],
            [
              180.16,
              1286.5
            ],
            [
              180.17,
              969.6
            ],
            [
              180.18,
              686.7
            ],
            [
              180.19,
              1124.4
            ]
          ],
          "volume": [
            12038.2,
            9115.400000000001
          ],
          "timestamp": 1754720495139,
          "latency": 2493
        },
        "timestamp": 1754720495139
      }
    },
    "dragHandle": ".drag-handle",
    "width": 452,
    "height": 658,
    "selected": false,
    "positionAbsolute": {
      "x": -1035,
      "y": 3570
    },
    "dragging": false
  },
  {
    "id": "node-1754720659066",
    "type": "custom",
    "position": {
      "x": -2760,
      "y": 3570
    },
    "data": {
      "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.book",
      "label": "testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.book",
      "sessionData": {
        "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.book",
        "module": "book",
        "widget": "widget.testnet.runtime.connector.exchange.crypto.bybit.spot.SOL/USDT.book",
        "raw": {
          "exchange": "bybit",
          "market": "SOL/USDT",
          "bids": [
            [
              180.24,
              74.43
            ],
            [
              180.23,
              7.018
            ],
            [
              180.22,
              43.023
            ],
            [
              180.21,
              36.991
            ],
            [
              180.2,
              51.078
            ],
            [
              180.19,
              92.197
            ],
            [
              180.18,
              86.988
            ],
            [
              180.17,
              70.128
            ],
            [
              180.16,
              81.972
            ],
            [
              180.15,
              136.026
            ]
          ],
          "asks": [
            [
              180.25,
              88.994
            ],
            [
              180.26,
              74.332
            ],
            [
              180.27,
              108.362
            ],
            [
              180.28,
              119.293
            ],
            [
              180.29,
              72.493
            ],
            [
              180.3,
              56.614
            ],
            [
              180.31,
              109.688
            ],
            [
              180.32,
              32.336
            ],
            [
              180.33,
              145.872
            ],
            [
              180.34,
              396.427
            ]
          ],
          "volume": [
            679.8509999999999,
            1204.411
          ],
          "timestamp": 1754720655285,
          "latency": 1256
        },
        "timestamp": 1754720655285
      }
    },
    "dragHandle": ".drag-handle",
    "width": 452,
    "height": 658,
    "selected": false,
    "positionAbsolute": {
      "x": -2760,
      "y": 3570
    },
    "dragging": false
  },
  {
    "id": "node-1754720668487",
    "type": "custom",
    "position": {
      "x": -2760,
      "y": 4245
    },
    "data": {
      "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.book",
      "label": "testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.book",
      "sessionData": {
        "channel": "testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.book",
        "module": "book",
        "widget": "widget.testnet.runtime.connector.exchange.crypto.bybit.spot.BTC/USDT.book",
        "raw": {
          "exchange": "bybit",
          "market": "BTC/USDT",
          "bids": [
            [
              116692.3,
              0.815787
            ],
            [
              116692.2,
              0.00834
            ],
            [
              116691.5,
              0.008567
            ],
            [
              116691.3,
              0.022563
            ],
            [
              116690.1,
              0.000857
            ],
            [
              116689.8,
              0.009
            ],
            [
              116687.6,
              0.007682
            ],
            [
              116687.4,
              0.03078
            ],
            [
              116686.5,
              0.000065
            ],
            [
              116685.7,
              0.001
            ]
          ],
          "asks": [
            [
              116692.4,
              1.297191
            ],
            [
              116692.8,
              0.008847
            ],
            [
              116692.9,
              0.015438
            ],
            [
              116693.5,
              0.003256
            ],
            [
              116693.8,
              0.004283
            ],
            [
              116694.7,
              0.003256
            ],
            [
              116695.9,
              0.003256
            ],
            [
              116696.4,
              0.012854
            ],
            [
              116697,
              0.003256
            ],
            [
              116698.2,
              0.044919
            ]
          ],
          "volume": [
            0.904641,
            1.3965559999999997
          ],
          "timestamp": 1754720665991,
          "latency": 1217
        },
        "timestamp": 1754720665991
      }
    },
    "dragHandle": ".drag-handle",
    "width": 452,
    "height": 658,
    "selected": false,
    "positionAbsolute": {
      "x": -2760,
      "y": 4245
    },
    "dragging": false
  }
]

/**
 * Widget data structure from session storage
 */
export interface WidgetData {
  module: string;
  channel: string;
  timestamp: number | string | object;

  [key: string]: unknown;
}

/**
 * Session storage data structure
 */
export interface SessionStore {
  [key: string]: WidgetData;
}

/**
 * Props for the DockItem component
 */
interface DockItemProps {
  /** Icon to display in the dock */
  icon: React.ReactNode;
  /** Label to display in the tooltip */
  label: string;
  /** Whether the item is currently active */
  isActive?: boolean;
  /** Callback when the item is clicked */
  onClick: () => void;
}

/**
 * Props for the MacOSDock component
 */
interface MacOSDockProps {
  /** Callback to open the widget store */
  onOpenWidgetStore: () => void;
  /** Whether the widget store is currently open */
  isWidgetStoreOpen: boolean;
}

/**
 * Props for the GroupHeader component
 */
interface GroupHeaderProps {
  /** Title of the group */
  title: string;
  /** Number of items in the group */
  count: number;
  /** Whether the group is currently expanded */
  isOpen: boolean;
  /** Callback when the group is toggled */
  onToggle: () => void;
  /** Indentation level (0 for top level) */
  level?: number;
}

/**
 * Props for the ItemStore component
 */
interface ItemStoreProps {
  /** Key of the widget in session storage */
  keyStore: string;
  /** Callback when drag starts */
  onDragStart: (
    event: React.DragEvent<HTMLDivElement>,
    keyStore: string,
  ) => void;
  /** Indentation level for nested items */
  indentLevel?: number;
}

/**
 * Props for the Tab component
 */
interface TabProps {
  /** Label to display in the tab */
  label: string;
  /** Whether the tab is currently active */
  isActive: boolean;
  /** Callback when the tab is clicked */
  onClick: () => void;
  /** Number of items in the tab */
  count: number;
}

/**
 * Type for grouped widgets by exchange and asset
 */
type GroupedWidgets = {
  [exchange: string]: {
    [asset: string]: string[];
  };
};

/**
 * Type for widget categories
 */
type WidgetCategories = Record<string, string[]>;

/**
 * Type for grouping mode
 */
type GroupingMode = "exchange" | "asset";

/**
 * Helper function to extract category from widget key
 */
function extractNetwork(key: string): string {
  const parts = key.split(".");
  return parts[1];
}

/**
 * Dock Item Component
 */
function DockItem(
  { icon, label, isActive = false, onClick }: DockItemProps,
): React.ReactElement {
  const [isHovered, setIsHovered] = useState<boolean>(false);

  return (
    <div className="group relative flex flex-col items-center">
      <div
        className={cn(
          "absolute bottom-full mb-2 rounded-md bg-black/80 px-2 py-1 text-xs text-white opacity-0 transition-opacity",
          (isHovered || isActive) && "opacity-100",
        )}
      >
        {label}
      </div>

      <button
        onClick={onClick}
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
        className={cn(
          "flex h-12 w-12 items-center justify-center rounded-full bg-white/10 backdrop-blur-md transition-all duration-200 hover:scale-110 hover:bg-white/20",
          isActive && "bg-white/30",
        )}
      >
        {icon}
      </button>
      {isActive && <div className="mt-1 h-1 w-1 rounded-full bg-white" />}
    </div>
  );
}

/**
 * macOS Dock Component
 */
function MacOSDock(
  { onOpenWidgetStore, isWidgetStoreOpen }: MacOSDockProps,
): React.ReactElement {
  return (
    <div className="absolute bottom-4 left-1/2 z-20 -translate-x-1/2 rounded-2xl bg-black/20 p-2 backdrop-blur-lg">
      <div className="flex items-center space-x-2">
        <DockItem
          icon={<ShoppingBag className="h-6 w-6" />}
          label="Widget Store"
          isActive={isWidgetStoreOpen}
          onClick={onOpenWidgetStore}
        />
      </div>
    </div>
  );
}

/**
 * Group Header Component
 */
function GroupHeader(
  { title, count, isOpen, onToggle, level = 0 }: GroupHeaderProps,
): React.ReactElement {
  return (
    <div
      onClick={onToggle}
      className={cn(
        "flex items-center justify-between p-2 cursor-pointer hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors",
        level === 0
          ? "bg-zinc-200/50 dark:bg-zinc-700/50"
          : "bg-zinc-100/50 dark:bg-zinc-800/50",
        level === 0 ? "sticky top-0" : "",
      )}
      style={{ paddingLeft: `${level * 8 + 8}px` }}
    >
      <div className="flex items-center">
        {isOpen
          ? <ChevronDown className="h-4 w-4 mr-1 text-zinc-500" />
          : <ChevronRight className="h-4 w-4 mr-1 text-zinc-500" />}
        <span
          className={cn("font-medium", level === 0 ? "text-sm" : "text-xs")}
        >
          {title}
        </span>
      </div>
      <span className="text-xs px-1.5 py-0.5 rounded-full bg-zinc-200 dark:bg-zinc-700">
        {count}
      </span>
    </div>
  );
}

/**
 * Item Store Component
 */
function ItemStore(
  { keyStore, onDragStart, indentLevel = 0 }: ItemStoreProps,
): React.ReactElement {
  const session = useSessionStoreSync() as SessionStore | null;

  if (!session) return <div>Loading Session....</div> as React.ReactElement;

  const widget = session[keyStore];

  if (!widget || !widget.module) {
    return <div>Invalid widget data</div> as React.ReactElement;
  }

  return (
    <div
      draggable
      onDragStart={(event) => onDragStart(event, keyStore)}
      onTouchStart={(event: React.TouchEvent<HTMLDivElement>) => {
        onDragStart(
          event as unknown as React.DragEvent<HTMLDivElement>,
          keyStore,
        );
      }}
      className="flex bg-amber-600 text-black touch-auto text-sm justify-between items-center p-2 border-b cursor-grab"
      style={{ paddingLeft: `${indentLevel * 8 + 8}px` }}
    >
      <div>
        <div>
          <div>Module: {widget.module}</div>
          <div className="text-[10px]">Channel: {widget.channel}</div>
        </div>
        <code>
          <pre>{JSON.stringify(widget.timestamp, null, 2)}</pre>
        </code>
      </div>
    </div>
  );
}

/**
 * Tab Component
 */
function Tab(
  { label, isActive, onClick, count }: TabProps,
): React.ReactElement {
  return (
    <button
      onClick={onClick}
      className={cn(
        "px-4 py-2 text-sm font-medium transition-colors",
        isActive
          ? "border-b-2 border-amber-500 text-amber-500"
          : "text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-300",
      )}
    >
      {label}{" "}
      {count > 0 && (
        <span className="ml-1 rounded-full px-2 py-0.5 text-xs dark:bg-zinc-700">
          {count}
        </span>
      )}
    </button>
  );
}

/**
 * Main Flow Component
 */
function Flow(): React.ReactElement | null {
  const [nodes, setNodes, onNodesChange] = useNodesState<FlowNodeData>([]);
  const [edges, setEdges, onEdgesChange] = useEdgesState<Edge>([]);

  const [isWidgetStoreOpen, setIsWidgetStoreOpen] = useState<boolean>(false);
  const [activeCategory, setActiveCategory] = useState<string>("All");
  const [searchTerm, setSearchTerm] = useState<string>("");
  const [expandedExchanges, setExpandedExchanges] = useState<
    Record<string, boolean>
  >({});
  const [expandedAssets, setExpandedAssets] = useState<Record<string, boolean>>(
    {},
  );
  const [groupingMode, setGroupingMode] = useState<GroupingMode>("exchange");

  const session = useSessionStoreSync() as SessionStore | null;
  const reactFlowInstance = useRef<ReactFlowInstance | null>(null);
  const { screenToFlowPosition } = useReactFlow();

  useEffect(() => {
    try {
      const savedNodes = localStorage.getItem(NODES_STORAGE_KEY);
      const savedEdges = localStorage.getItem(EDGES_STORAGE_KEY);

      if (savedNodes) {
        const parsedNodes = JSON.parse(savedNodes);
        const nodesWithFunctions = parsedNodes.map((node: FlowNode) => ({
          ...node,
          data: {
            ...node.data,
            onDelete: handleDeleteNode,
          },
        }));
        setNodes(nodesWithFunctions);
      } else {
        localStorage.setItem(NODES_STORAGE_KEY, JSON.stringify(defaultNodes));
        const parsedNodes = defaultNodes;
        const nodesWithFunctions = parsedNodes.map((node: FlowNode) => ({
          ...node,
          data: {
            ...node.data,
            onDelete: handleDeleteNode,
          },
        }));
        setNodes(nodesWithFunctions);
      }

      if (savedEdges) {
        setEdges(JSON.parse(savedEdges));
      }
    } catch (error) {
      console.error("Error loading flow data from localStorage:", error);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    if (nodes.length > 0) {
      const nodesToSave = nodes.map((node) => ({
        ...node,
        data: {
          ...node.data,
          onDelete: undefined,
        },
      }));
      localStorage.setItem(NODES_STORAGE_KEY, JSON.stringify(nodesToSave));
    }
    cleanBrands();
  }, [nodes]);

  useEffect(() => {
    if (edges.length > 0) {
      localStorage.setItem(EDGES_STORAGE_KEY, JSON.stringify(edges));
    }
  }, [edges]);

  const onConnect = useCallback(
    (params: Edge | Connection) => {
      setEdges((eds) => {
        const newEdges = addEdge(params, eds);
        localStorage.setItem(EDGES_STORAGE_KEY, JSON.stringify(newEdges));
        return newEdges;
      });
    },
    [setEdges],
  );

  const handleDeleteNode = useCallback(
    (nodeId: string) => {
      setNodes((nds) => {
        const updatedNodes = nds.filter((node) => node.id !== nodeId);
        setEdges((edges) => {
          const updatedEdges = edges.filter((edge) =>
            edge.source !== nodeId && edge.target !== nodeId
          );
          localStorage.setItem(EDGES_STORAGE_KEY, JSON.stringify(updatedEdges));
          return updatedEdges;
        });

        if (updatedNodes.length === 0) {
          localStorage.removeItem(NODES_STORAGE_KEY);
        } else {
          const nodesToSave = updatedNodes.map((node) => ({
            ...node,
            data: {
              ...node.data,
              onDelete: undefined,
            },
          }));
          localStorage.setItem(NODES_STORAGE_KEY, JSON.stringify(nodesToSave));
        }

        return updatedNodes;
      });
    },
    [setNodes, setEdges],
  );

  const onDragStart = (
    event: React.DragEvent<HTMLDivElement>,
    key: string,
  ): void => {
    event.dataTransfer.setData("application/reactflow", key);
    event.dataTransfer.effectAllowed = "move";
  };

  const onDrop = (event: React.DragEvent<HTMLDivElement>): void => {
    event.preventDefault();

    const key = event.dataTransfer.getData("application/reactflow");
    const sessionData = sessionStorage.getItem(key);
    if (!sessionData) return;

    const position = screenToFlowPosition({
      x: event.clientX,
      y: event.clientY,
    });

    const newNodeId = `node-${Date.now()}`;

    const newNode = {
      id: newNodeId,
      type: "custom",
      position,
      data: {
        channel: key,
        label: key,
        onDelete: handleDeleteNode,
        sessionData: JSON.parse(sessionData),
      },
      dragHandle: ".drag-handle",
    };

    setNodes((prevNodes) => {
      const updatedNodes = [...prevNodes, newNode];
      const nodesToSave = updatedNodes.map((node) => ({
        ...node,
        data: {
          ...node.data,
          onDelete: undefined,
        },
      }));
      localStorage.setItem(NODES_STORAGE_KEY, JSON.stringify(nodesToSave));

      return updatedNodes;
    });
  };

  const onDragOver = (event: React.DragEvent<HTMLDivElement>): void => {
    event.preventDefault();
    event.dataTransfer.dropEffect = "move";
  };

  const nodeTypes = useMemo<NodeTypes>(
    () => ({
      custom: MacOSNode,
    }),
    [],
  );

  const toggleWidgetStore = (): void => {
    setIsWidgetStoreOpen(!isWidgetStoreOpen);
  };

  const toggleExchange = (exchange: string): void => {
    setExpandedExchanges((prev) => ({
      ...prev,
      [exchange]: !prev[exchange],
    }));
  };

  const toggleAsset = (exchange: string, asset: string): void => {
    const key = `${exchange}:${asset}`;
    setExpandedAssets((prev) => ({
      ...prev,
      [key]: !prev[key],
    }));
  };

  const keys = Object.keys(sessionStorage);

  const widgetsByCategory = useMemo<WidgetCategories>(() => {
    const categorized: WidgetCategories = { All: [] };

    if (session) {
      keys.forEach((key) => {
        const widget = session[key];
        if (widget && widget.module) {
          // Add to "All" category
          categorized.All.push(key);

          // Add to specific category
          const category = extractNetwork(key);
          if (!categorized[category]) {
            categorized[category] = [];
          }
          categorized[category].push(key);
        }
      });
    }

    return categorized;
  }, [keys, session]);

  const categories = useMemo<string[]>(() => {
    return Object.keys(widgetsByCategory).sort((a, b) => {
      if (a === "All") return -1;
      if (b === "All") return 1;
      return a.localeCompare(b);
    });
  }, [widgetsByCategory]);

  const filteredWidgets = useMemo<string[]>(() => {
    const categoryWidgets = widgetsByCategory[activeCategory] || [];

    if (!searchTerm) {
      return categoryWidgets;
    }

    return categoryWidgets.filter((key) => {
      if (!session) return false;
      const widget = session[key];
      const searchLower = searchTerm.toLowerCase();

      return widget.module.toLowerCase().includes(searchLower) ||
        widget.channel.toLowerCase().includes(searchLower);
    });
  }, [activeCategory, searchTerm, widgetsByCategory, session]);

  const groupedWidgets = useMemo<GroupedWidgets>(() => {
    const grouped: GroupedWidgets = {};

    filteredWidgets.forEach((key) => {
      const exchange = extractNetwork(key);
      const asset = extractNetwork(key);

      if (!grouped[exchange]) {
        grouped[exchange] = {};
      }

      if (!grouped[exchange][asset]) {
        grouped[exchange][asset] = [];
      }

      grouped[exchange][asset].push(key);

      if (
        Object.keys(expandedExchanges).length === 0 &&
        Object.keys(grouped).length > 0
      ) {
        setExpandedExchanges({ [exchange]: true });
        setExpandedAssets({ [`${exchange}:${asset}`]: true });
      }
    });

    return grouped;
  }, [filteredWidgets, expandedExchanges]);

  const toggleGroupingMode = (): void => {
    setGroupingMode((prev) => (prev === "exchange" ? "asset" : "exchange"));
  };

  const renderGroupedWidgets = (): React.ReactNode => {
    if (filteredWidgets.length === 0) {
      return (
        <div className="p-4 text-center text-muted-foreground">
          {searchTerm
            ? "No widgets match your search"
            : "No widgets available in this category"}
        </div>
      );
    }

    if (groupingMode === "exchange") {
      return Object.entries(groupedWidgets).map(([exchange, assets]) => {
        const isExchangeOpen = expandedExchanges[exchange] || false;
        const exchangeWidgetCount = Object.values(assets).flat().length;

        return (
          <div key={exchange} className="border-b last:border-b-0">
            <GroupHeader
              title={`Exchange: ${exchange}`}
              count={exchangeWidgetCount}
              isOpen={isExchangeOpen}
              onToggle={() => toggleExchange(exchange)}
              level={0}
            />

            {isExchangeOpen &&
              Object.entries(assets).map(([asset, assetWidgets]) => {
                const assetKey = `${exchange}:${asset}`;
                const isAssetOpen = expandedAssets[assetKey] || false;

                return (
                  <div
                    key={assetKey}
                    className="border-t border-zinc-100 dark:border-zinc-800"
                  >
                    <GroupHeader
                      title={`${asset}`}
                      count={assetWidgets.length}
                      isOpen={isAssetOpen}
                      onToggle={() => toggleAsset(exchange, asset)}
                      level={1}
                    />

                    {isAssetOpen &&
                      assetWidgets.map((keyStore) => (
                        <ItemStore
                          key={keyStore}
                          keyStore={keyStore}
                          onDragStart={(event) => onDragStart(event, keyStore)}
                          indentLevel={2}
                        />
                      ))}
                  </div>
                );
              })}
          </div>
        );
      });
    } else {
      const assetFirst: Record<string, Record<string, string[]>> = {};

      Object.entries(groupedWidgets).forEach(([exchange, assets]) => {
        Object.entries(assets).forEach(([asset, widgets]) => {
          if (!assetFirst[asset]) {
            assetFirst[asset] = {};
          }
          assetFirst[asset][exchange] = widgets;
        });
      });

      return Object.entries(assetFirst).map(([asset, exchanges]) => {
        const isAssetOpen = expandedAssets[asset] || false;
        const assetWidgetCount = Object.values(exchanges).flat().length;

        return (
          <div key={asset} className="border-b last:border-b-0">
            <GroupHeader
              title={`${asset}`}
              count={assetWidgetCount}
              isOpen={isAssetOpen}
              onToggle={() => toggleAsset("", asset)}
              level={0}
            />

            {isAssetOpen &&
              Object.entries(exchanges).map(([exchange, exchangeWidgets]) => {
                const exchangeKey = `${asset}:${exchange}`;
                const isExchangeOpen = expandedExchanges[exchangeKey] || false;

                return (
                  <div
                    key={exchangeKey}
                    className="border-t border-zinc-100 dark:border-zinc-800"
                  >
                    <GroupHeader
                      title={`${exchange}`}
                      count={exchangeWidgets.length}
                      isOpen={isExchangeOpen}
                      onToggle={() => toggleExchange(exchangeKey)}
                      level={1}
                    />

                    {isExchangeOpen &&
                      exchangeWidgets.map((keyStore) => (
                        <ItemStore
                          key={keyStore}
                          keyStore={keyStore}
                          onDragStart={(event) => onDragStart(event, keyStore)}
                          indentLevel={2}
                        />
                      ))}
                  </div>
                );
              })}
          </div>
        );
      });
    }
  };

  if (!session) return null;

  return (
    <div className="absolute w-[100%] h-[100%] top-0 left-0">
      <ReactFlow
        nodes={nodes}
        edges={edges}
        onNodesChange={onNodesChange}
        onEdgesChange={onEdgesChange}
        onConnect={onConnect}
        nodeTypes={nodeTypes}
        snapToGrid={true}
        fitView
        onInit={(instance) => {
          reactFlowInstance.current = instance;
        }}
        onDrop={onDrop}
        onDragOver={onDragOver}
        minZoom={0.4}
      >
        <Background className="stels-canvas" color={"#222222"} gap={10} size={1}/>
        <div className="absolute z-1 flex justify-center items-center flex-col w-60 h-60 bottom-0 right-0">
          <div>
            <Graphite size={4} primary="orange" />
          </div>
          <div className="mt-4 text-2xl font-semibold text-zinc-800/60">
            STELS
          </div>
          <div className="mt-0 text-sm text-zinc-600/30">
            Artificial Market Intelligence
          </div>
        </div>
      </ReactFlow>

      <MacOSDock
        onOpenWidgetStore={toggleWidgetStore}
        isWidgetStoreOpen={isWidgetStoreOpen}
      />

      <div
        className={cn(
          "absolute top-4 bottom-20 right-4 z-50 w-1/3 border bg-background/90 rounded-lg overflow-hidden transition-all duration-300 transform backdrop-blur-md",
          isWidgetStoreOpen
            ? "translate-x-0 opacity-100"
            : "translate-x-full opacity-0",
        )}
      >
        <div className="border-b p-3 flex justify-between items-center bg-muted/80">
          <div className="flex items-center">
            <ShoppingBag className="h-4 w-4 mr-2" />
            <h3 className="font-semibold">Widget Store</h3>
          </div>
          <div className="flex space-x-2">
            <button
              className="h-3 w-3 rounded-full bg-[#febc2e]"
              onClick={() => {
              }}
            />
            <button
              className="h-3 w-3 rounded-full bg-[#ff5f57]"
              onClick={toggleWidgetStore}
            />
          </div>
        </div>

        <div className="p-3 border-b">
          <div className="flex gap-2">
            <div className="relative flex-1">
              <input
                type="text"
                placeholder="Search widgets..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full px-3 py-2 pl-9 bg-zinc-100 dark:bg-zinc-800 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-amber-500"
              />
              <Filter className="absolute left-3 top-2.5 h-4 w-4 text-zinc-400" />
            </div>
            <button
              onClick={toggleGroupingMode}
              className="px-3 py-1 bg-amber-500 hover:bg-amber-600 text-white rounded-md text-xs font-medium"
            >
              Group by: {groupingMode === "exchange" ? "Exchange" : "Asset"}
            </button>
          </div>
        </div>

        <div className="border-b overflow-x-auto">
          <div className="flex whitespace-nowrap">
            {categories.map((category) => (
              <Tab
                key={category}
                label={category}
                isActive={activeCategory === category}
                onClick={() => setActiveCategory(category)}
                count={widgetsByCategory[category]?.length || 0}
              />
            ))}
          </div>
        </div>

        <div className="h-[calc(100%-144px)] overflow-y-auto">
          {renderGroupedWidgets()}
        </div>
      </div>
    </div>
  );
}

export default Flow;
